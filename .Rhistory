)
dopisy = vyhodnoceni %>%
mutate(
dopis =
paste0("Milá účastnice, milý účastníku turnaje PGG,\n\n\n\n",
"nejprve Vám ještě jednou srdečně děkujeme za Vaší účast v turnaji -- be Vás by nebylo možné zkoumat ",
"lidskou kooperaci, která byla předmětem naší studie. ",
"Dále Vám v e-mailu sdělujeme Váš výsledek v turnaji a jaká odměna Vám náleží. \n\n",
"Jelikož vaše skupina získala dohromady ", soucetSkupiny, " HK a Vy osobně ",
celkem, " HK, jste v celkovém pořadí ", umisteni, odmenit, "\n\n",
"Pro zajímavost, maximálního možného výsledku 1600 HK za celou skupinu dosáhlo 6 skupin a ",
"jejich členky a členové si tak rovným dílem rozdělili odměny za 1. až 24. místo ",
"(všichni shodně měli osobní výsledek 400 HK, jinak konec konců nebylo možné maxima dosáhnout). ",
"Nejvyšší osobní výsledek v celém turnaji je 417,5 HK, ale ten znamenal 'jen' 29. místo.",
"\n\n\n\nS úctou,\nFrantišek Kalvas a Pavlína Máchová")
)
dopisy = vyhodnoceni %>%
mutate(
dopis =
paste0("Milá účastnice, milý účastníku turnaje PGG,\n\n\n\n",
"nejprve Vám ještě jednou srdečně děkujeme za Vaší účast v turnaji -- bez Vás by nebylo možné zkoumat ",
"lidskou kooperaci, která byla předmětem naší studie. ",
"Dále Vám v e-mailu sdělujeme Váš výsledek v turnaji a jaká odměna Vám náleží. \n\n",
"Jelikož vaše skupina získala dohromady ", soucetSkupiny, " HK a Vy osobně ",
celkem, " HK, jste v celkovém pořadí ", umisteni, odmenit, "\n\n",
"Pro zajímavost, maximálního možného výsledku 1600 HK za celou skupinu dosáhlo 6 skupin a ",
"jejich členky a členové si tak rovným dílem rozdělili odměny za 1. až 24. místo ",
"(všichni shodně měli osobní výsledek 400 HK, jinak konec konců nebylo možné maxima dosáhnout). ",
"Nejvyšší osobní výsledek v celém turnaji je 417,5 HK, ale ten znamenal 'jen' 29. místo.",
"\n\n\n\nS úctou,\nFrantišek Kalvas a Pavlína Máchová")
)
## Tak... Teď připojím `odmeny` jako další proměnnou do `vyhodnoceni` a
# rovnou každému vypočtu jeho odměnu:
# 1) seskupím je podle `soucetSkupiny` a podle `celkem`, tím mi přirozeně vzniknou skupinky,
#    které si budou dělit odměny průměrem (při rovnosti bodů skupiny vytváří `super-skupiny`
#    a uvnitř nich si dělí odměnu rovným dílem hráči se stejným počtem bodů)
# 2) uvnitř skupin daných rovnými body (jak skupin tak hráčů) spočítám průměrné odměny
# 3) když budou body unikátní, zkrátka se replikuje hodnota, když ne, rozdělí se
# 4) využívám toho, že žebříček hráčů a jejich výsledků už je seřazený sestupně, od nejlepší skupiny
#    po nejhorší, a totéž s hráči, když k tomu pak přidám sestupně seřazené odměny, snadno to spočtu
vyhodnoceni = cbind(dfv, 'odmena' = odmeny, misto = 1:nrow(dfv)) %>% group_by(soucetSkupiny, celkem) %>%
mutate(odmena = mean(odmena),
odmena = if_else(odmena == 368.75, 370, odmena),  # Bude to stát sice 30 Kč navíc, ale zaokrouhlíme to na celé desetikoruny nahoru, přeci nebudu 24 vítězům posílat 368.75 Kč 24x...
# 5) a rovnou si tu připravím proměnné nutné pro sestavení emailu hráčům
od = min(misto),
do = max(misto),
umisteni = if_else(od == do,
paste0("na ", od, ". místě"),
paste0("na ", od, ". až ", do, ". místě")),
odmenit= if_else(odmena == 0,
". Toto umístění je, Bohu žel, bez finanční odměny.",
paste0(", za což Vám náleží odměna ", odmena, " Kč. Pošlete nám prosím číslo účtu, abychom Vám mohli odměnu zaslat."))
)
vyhodnoceni
dopisy = vyhodnoceni %>%
mutate(
dopis =
paste0("Milá účastnice, milý účastníku turnaje PGG,\n\n\n\n",
"nejprve Vám ještě jednou srdečně děkujeme za Vaší účast v turnaji -- bez Vás by nebylo možné zkoumat ",
"lidskou kooperaci, která byla předmětem naší studie. ",
"Dále Vám v e-mailu sdělujeme Váš výsledek v turnaji a jaká odměna Vám náleží. \n\n",
"Jelikož vaše skupina získala dohromady ", soucetSkupiny, " HK a Vy osobně ",
celkem, " HK, jste v celkovém pořadí ", umisteni, odmenit, "\n\n",
"Pro zajímavost, maximálního možného výsledku 1600 HK za celou skupinu dosáhlo 6 skupin a ",
"jejich členky a členové si tak rovným dílem rozdělili odměny za 1. až 24. místo ",
"(všichni shodně měli osobní výsledek 400 HK, jinak konec konců nebylo možné maxima dosáhnout). ",
"Nejvyšší osobní výsledek v celém turnaji je 417,5 HK, ale ten znamenal 'jen' 29. místo.",
"\n\n\n\nS úctou,\nFrantišek Kalvas a Pavlína Máchová")
)
dopisy = vyhodnoceni %>%
mutate(
dopis =
paste0("Milá účastnice, milý účastníku turnaje PGG,\n\n\n\n",
"nejprve Vám ještě jednou srdečně děkujeme za Vaší účast v turnaji -- bez Vás by nebylo možné zkoumat ",
"lidskou kooperaci, která byla předmětem naší studie. ",
"Dále Vám v e-mailu sdělujeme Váš výsledek v turnaji a jaká odměna Vám náleží. \n\n",
"Jelikož vaše skupina získala dohromady ", soucetSkupiny, " HK a Vy osobně ",
celkem, " HK, jste v celkovém pořadí ", umisteni, odmenit, "\n\n",
"Pro zajímavost, maximálního možného výsledku 1600 HK za celou skupinu dosáhlo 6 skupin a ",
"jejich členky a členové si tak rovným dílem rozdělili odměny za 1. až 24. místo ",
"(všichni shodně měli osobní výsledek 400 HK, jinak konec konců nebylo možné maxima dosáhnout). ",
"Nejvyšší osobní výsledek v celém turnaji je 417,5 HK, ale ten znamenal 'jen' 29. místo.",
"\n\n\n\nS úctou,\nFrantišek Kalvas a Pavlína Máchová")
) %>% select(email, dopis)
dopisy
dopisy = vyhodnoceni %>%
mutate(
dopis =
paste0("Milá účastnice, milý účastníku turnaje PGG,\n\n\n\n",
"nejprve Vám ještě jednou srdečně děkujeme za Vaší účast v turnaji -- bez Vás by nebylo možné zkoumat ",
"lidskou kooperaci, která byla předmětem naší studie. ",
"Dále Vám v e-mailu sdělujeme Váš výsledek v turnaji a jaká odměna Vám náleží. \n\n",
"Jelikož vaše skupina získala dohromady ", soucetSkupiny, " HK a Vy osobně ",
celkem, " HK, jste v celkovém pořadí ", umisteni, odmenit, "\n\n",
"Pro zajímavost, maximálního možného výsledku 1600 HK za celou skupinu dosáhlo 6 skupin a ",
"jejich členky a členové si tak rovným dílem rozdělili odměny za 1. až 24. místo ",
"(všichni shodně měli osobní výsledek 400 HK, jinak konec konců nebylo možné maxima dosáhnout). ",
"Nejvyšší osobní výsledek v celém turnaji je 417,5 HK, ale ten znamenal 'jen' 29. místo.",
"\n\n\n\nS úctou,\nFrantišek Kalvas a Pavlína Máchová")
) %>% ungroup %>% select(email, dopis)
dopisy
dopisy = vyhodnoceni %>%
mutate(
dopis =
paste0("Milá účastnice, milý účastníku turnaje PGG,\n\n\n\n",
"nejprve Vám ještě jednou srdečně děkujeme za Vaší účast v turnaji -- bez Vás by nebylo možné zkoumat ",
"lidskou kooperaci, která byla předmětem naší studie. ",
"Dále Vám v e-mailu sdělujeme Váš výsledek v turnaji a jaká odměna Vám náleží. \n\n",
"Jelikož vaše skupina získala dohromady ", soucetSkupiny, " HK a Vy osobně ",
celkem, " HK, jste v celkovém pořadí ", umisteni, odmenit, "\n\n",
"Pro zajímavost, maximálního možného výsledku 1600 HK za celou skupinu dosáhlo 6 skupin a ",
"jejich členky a členové si tak rovným dílem rozdělili odměny za 1. až 24. místo ",
"(všichni shodně měli osobní výsledek 400 HK, jinak konec konců nebylo možné maxima dosáhnout). ",
"Nejvyšší osobní výsledek v celém turnaji je 417,5 HK, ale ten znamenal 'jen' 29. místo.",
"\n\n\n\nS úctou,\nFrantišek Kalvas a Pavlína Máchová")
) %>% ungroup %>% select(email, dopis) %>% filter(!is.na(email))
dopisy
## Smazání paměti
rm(list = ls())
## Package
library(dplyr)
## Načtení dat
load("vsechnaCistaData.RData")
## Nejdřív je potřeba znovu vygenerovat vyhodnoceni:
dfv = vysledek %>% ungroup() %>% arrange(., desc(soucetSkupiny), desc(celkem)) %>%
select(email, session, soucetSkupiny, celkem) #%>%
## Teď je potřeba vůbec nadefinovat vektor s odměnami a doplnit 0 na délku `vyhodnoceni`:
odmeny = c(seq(1000, 500, -100), 450, 400, 400, 350, rep(300,3), 250, rep(200, 5), 150,
150, rep(100, 6), rep(50, 16), 25, 25, rep(0, nrow(dfv) - 45))
## Tak... Teď připojím `odmeny` jako další proměnnou do `vyhodnoceni` a
# rovnou každému vypočtu jeho odměnu:
# 1) seskupím je podle `soucetSkupiny` a podle `celkem`, tím mi přirozeně vzniknou skupinky,
#    které si budou dělit odměny průměrem (při rovnosti bodů skupiny vytváří `super-skupiny`
#    a uvnitř nich si dělí odměnu rovným dílem hráči se stejným počtem bodů)
# 2) uvnitř skupin daných rovnými body (jak skupin tak hráčů) spočítám průměrné odměny
# 3) když budou body unikátní, zkrátka se replikuje hodnota, když ne, rozdělí se
# 4) využívám toho, že žebříček hráčů a jejich výsledků už je seřazený sestupně, od nejlepší skupiny
#    po nejhorší, a totéž s hráči, když k tomu pak přidám sestupně seřazené odměny, snadno to spočtu
vyhodnoceni = cbind(dfv, 'odmena' = odmeny, misto = 1:nrow(dfv)) %>% group_by(soucetSkupiny, celkem) %>%
mutate(odmena = mean(odmena),
odmena = if_else(odmena == 368.75, 370, odmena),  # Bude to stát sice 30 Kč navíc, ale zaokrouhlíme to na celé desetikoruny nahoru, přeci nebudu 24 vítězům posílat 368.75 Kč 24x...
# 5) a rovnou si tu připravím proměnné nutné pro sestavení emailu hráčům
od = min(misto),
do = max(misto),
umisteni = if_else(od == do,
paste0("na ", od, ". místě"),
paste0("na ", od, ". až ", do, ". místě")),
odmenit= if_else(odmena == 0,
". Toto umístění je, Bohu žel, bez finanční odměny.",
paste0(", za což Vám náleží odměna ", odmena, " Kč. Pošlete nám prosím číslo účtu, abychom Vám mohli odměnu zaslat."))
)
vyhodnoceni
dopisy = vyhodnoceni %>%
mutate(
dopis =
paste0("Milá účastnice, milý účastníku turnaje PGG,\n\n\n\n",
"nejprve Vám ještě jednou srdečně děkujeme za Vaší účast v turnaji -- bez Vás by nebylo možné zkoumat ",
"lidskou kooperaci, která byla předmětem naší studie. ",
"Dále Vám v e-mailu sdělujeme Váš výsledek v turnaji a jaká odměna Vám náleží. \n\n",
"Jelikož vaše skupina získala dohromady ", soucetSkupiny, " HK a Vy osobně ",
celkem, " HK, jste v celkovém pořadí ", umisteni, odmenit, "\n\n",
"Pro zajímavost, maximálního možného výsledku 1600 HK za celou skupinu dosáhlo 6 skupin a ",
"jejich členky a členové si tak rovným dílem rozdělili odměny za 1. až 24. místo ",
"(všichni shodně měli osobní výsledek 400 HK, jinak konec konců nebylo možné maxima dosáhnout). ",
"Nejvyšší osobní výsledek v celém turnaji je 417,5 HK, ale ten znamenal 'jen' 29. místo.",
"\n\n\n\nS úctou,\nFrantišek Kalvas a Pavlína Máchová")
) %>% ungroup %>% select(email, dopis) %>% filter(!is.na(email))
dopisy
library(emayili)
library(dplyr)
library(magrittr)
for (d in 1:nrow(dopisy)) {
email <- envelope() %>%
from("kalvas@kss.zcu.cz") %>%
to(dopisy$email[d]) %>%
subject(qp_encode("Vyhodnocení turnaje PGG (21.4.2021--2.5.2021)")) %>%
text(qp_encode(dopisy$dopis[d]))
# print(email, details = T)
smtp <- server(host = "smtp.zcu.cz",
port = 465,
username = "kalvas",
password = "Dingo933")
smtp(email, verbose = TRUE)
}
emaily = unz(archive, files$Name[2]) %>% read_csv() %>% rename(email = value)
## Získáme seznam souborů ve stažených datech
archive = "aktualniData.zip"
files = unzip(archive, list = T) %>%
filter(Length > 0) %>% filter(str_detect(Name, ".csv") )%>%
filter(!(str_detect(Name, "000015")|  # Příprava na další problematické místnosti, ano třeba 000018...
str_detect(Name, "000018")))  # V místnosti 15 je jen jeden soubor -- vstupní dotazník, jinak nic, jde tedy o nedohranou hru
files
## Na připsání času, kdy hra proběhla si vytvoříme zvláštní soubor
datumy = files[seq(5, nrow(files),5),] %>%
mutate(Name = substr(Name, 6, 15)) %>% select(-Length) %>%
rename(session = Name, date = Date)
datumy
bonus = unz(archive, files$Name[1]) %>% read_csv() %>% rename(player = id, celkem = bonus)
emaily = unz(archive, files$Name[2]) %>% read_csv() %>% rename(email = value)
PGG = unz(archive, files$Name[3]) %>% read_csv()
Q1 = unz(archive, files$Name[4]) %>% read_csv()
Q2 = unz(archive, files$Name[5]) %>% read_csv()
for (f in 1:(nrow(files)/5 - 1)) {
bonus = unz(archive, files$Name[f*5 + 1]) %>% read_csv() %>%
rename(player = id, celkem = bonus) %>% rbind(bonus, .)
emaily = unz(archive, files$Name[f*5 + 2]) %>% read_csv() %>%
rename(email = value) %>% rbind(emaily, .)
PGG = unz(archive, files$Name[f*5 + 3]) %>% read_csv() %>% rbind(PGG, .)
Q1 = unz(archive, files$Name[f*5 + 4]) %>% read_csv() %>% rbind(Q1, .)
Q2 = unz(archive, files$Name[f*5 + 5]) %>% read_csv() %>% rbind(Q2, .)
}
View(emaily)
## Tak... Teď připojím `odmeny` jako další proměnnou do `vyhodnoceni` a
# rovnou každému vypočtu jeho odměnu:
# 1) seskupím je podle `soucetSkupiny` a podle `celkem`, tím mi přirozeně vzniknou skupinky,
#    které si budou dělit odměny průměrem (při rovnosti bodů skupiny vytváří `super-skupiny`
#    a uvnitř nich si dělí odměnu rovným dílem hráči se stejným počtem bodů)
# 2) uvnitř skupin daných rovnými body (jak skupin tak hráčů) spočítám průměrné odměny
# 3) když budou body unikátní, zkrátka se replikuje hodnota, když ne, rozdělí se
# 4) využívám toho, že žebříček hráčů a jejich výsledků už je seřazený sestupně, od nejlepší skupiny
#    po nejhorší, a totéž s hráči, když k tomu pak přidám sestupně seřazené odměny, snadno to spočtu
vyhodnoceni = cbind(dfv, 'odmena' = odmeny, misto = 1:nrow(dfv)) %>% group_by(soucetSkupiny, celkem) %>%
mutate(odmena = mean(odmena),
odmena = if_else(odmena == 368.75, 370, odmena),  # Bude to stát sice 30 Kč navíc, ale zaokrouhlíme to na celé desetikoruny nahoru, přeci nebudu 24 vítězům posílat 368.75 Kč 24x...
# 5) a rovnou si tu připravím proměnné nutné pro sestavení emailu hráčům
od = min(misto),
do = max(misto),
umisteni = if_else(od == do,
paste0("na ", od, ". místě"),
paste0("na ", od, ". až ", do, ". místě")),
odmenit= if_else(odmena == 0,
". Toto umístění je, Bohu žel, bez finanční odměny.",
paste0(", za což Vám náleží odměna ", odmena, " Kč. Pošlete nám prosím číslo účtu, abychom Vám mohli odměnu zaslat.")),
email = if_else(email == "annaraichlova@s", "annaraichlova@seznam.cz", email)
)
vyhodnoceni
dopisy = vyhodnoceni %>%
mutate(
dopis =
paste0("Milá účastnice, milý účastníku turnaje PGG,\n\n\n\n",
"nejprve Vám ještě jednou srdečně děkujeme za Vaší účast v turnaji -- bez Vás by nebylo možné zkoumat ",
"lidskou kooperaci, která byla předmětem naší studie. ",
"Dále Vám v e-mailu sdělujeme Váš výsledek v turnaji a jaká odměna Vám náleží. \n\n",
"Jelikož vaše skupina získala dohromady ", soucetSkupiny, " HK a Vy osobně ",
celkem, " HK, jste v celkovém pořadí ", umisteni, odmenit, "\n\n",
"Pro zajímavost, maximálního možného výsledku 1600 HK za celou skupinu dosáhlo 6 skupin a ",
"jejich členky a členové si tak rovným dílem rozdělili odměny za 1. až 24. místo ",
"(všichni shodně měli osobní výsledek 400 HK, jinak konec konců nebylo možné maxima dosáhnout). ",
"Nejvyšší osobní výsledek v celém turnaji je 417,5 HK, ale ten znamenal 'jen' 29. místo.",
"\n\n\n\nS úctou,\nFrantišek Kalvas a Pavlína Máchová")
) %>% ungroup %>% select(email, dopis) %>% filter(!is.na(email))
dopisy
email <- envelope() %>%
from("kalvas@kss.zcu.cz") %>%
to(dopisy$email[13]) %>%
subject(qp_encode("Vyhodnocení turnaje PGG (21.4.2021--2.5.2021)")) %>%
text(qp_encode(dopisy$dopis[13]))
smtp <- server(host = "smtp.zcu.cz",
port = 465,
username = "kalvas",
password = "Dingo933")
smtp(email, verbose = TRUE)
library(writexl)
## Pro otestování adres ještě uložím adresy do Excelu a tam odtud to ručně nakopíruju do řádku mailu:
write_xlsx(dopisy, "kontrola.xlsx")
library(emayili)
library(dplyr)
library(magrittr)
library(emayili)
## Skript na zpracování a odeslání e-mailu s oznámením odměn účastníkům turnaje PGG
## Encoding: windows-1250
## Vytvořil: 2021-04-21 FrK
## Upravil: 2021-05-12 FrK
# ## Hlavička a načtení dat -----------------------------------------------
## Smazání paměti
rm(list = ls())
## Package
library(dplyr)
library(writexl)
## Načtení dat
load("vsechnaCistaData.RData")
# ## Odměny ---------------------------------------------------------------
## Nejdřív je potřeba znovu vygenerovat vyhodnoceni:
dfv = vysledek %>% ungroup() %>% arrange(., desc(soucetSkupiny), desc(celkem)) %>%
select(email, session, soucetSkupiny, celkem) #%>%
# group_by(email) %>% mutate(x = 1) %>% mutate(x = sum(x)) %>%   # Kontrola, jestli tam není nějaký email dvakrát.
# arrange(., desc(x), email)  # OK, dopadlo to dobře, každý mail tu je jen jednou!
# vyhodnoceni
## Teď je potřeba vůbec nadefinovat vektor s odměnami a doplnit 0 na délku `vyhodnoceni`:
odmeny = c(seq(1000, 500, -100), 450, 400, 400, 350, rep(300,3), 250, rep(200, 5), 150,
150, rep(100, 6), rep(50, 16), 25, 25, rep(0, nrow(dfv) - 45))
# length((odmeny))
# sum(odmeny)
# SUPER! Sedí to!
## Tak... Teď připojím `odmeny` jako další proměnnou do `vyhodnoceni` a
# rovnou každému vypočtu jeho odměnu:
# 1) seskupím je podle `soucetSkupiny` a podle `celkem`, tím mi přirozeně vzniknou skupinky,
#    které si budou dělit odměny průměrem (při rovnosti bodů skupiny vytváří `super-skupiny`
#    a uvnitř nich si dělí odměnu rovným dílem hráči se stejným počtem bodů)
# 2) uvnitř skupin daných rovnými body (jak skupin tak hráčů) spočítám průměrné odměny
# 3) když budou body unikátní, zkrátka se replikuje hodnota, když ne, rozdělí se
# 4) využívám toho, že žebříček hráčů a jejich výsledků už je seřazený sestupně, od nejlepší skupiny
#    po nejhorší, a totéž s hráči, když k tomu pak přidám sestupně seřazené odměny, snadno to spočtu
vyhodnoceni = cbind(dfv, 'odmena' = odmeny, misto = 1:nrow(dfv)) %>% group_by(soucetSkupiny, celkem) %>%
mutate(odmena = mean(odmena),
odmena = if_else(odmena == 368.75, 370, odmena),  # Bude to stát sice 30 Kč navíc, ale zaokrouhlíme to na celé desetikoruny nahoru, přeci nebudu 24 vítězům posílat 368.75 Kč 24x...
# 5) a rovnou si tu připravím proměnné nutné pro sestavení emailu hráčům
od = min(misto),
do = max(misto),
umisteni = if_else(od == do,
paste0("na ", od, ". místě"),
paste0("na ", od, ". až ", do, ". místě")),
odmenit= if_else(odmena == 0,
". Toto umístění je, Bohu žel, bez finanční odměny.",
paste0(", za což Vám náleží odměna ", odmena, " Kč. Pošlete nám prosím číslo účtu, abychom Vám mohli odměnu zaslat.")),
email = if_else(email == "annaraichlova@s", "annaraichlova@seznam.cz", email)
)
vyhodnoceni
dopisy = vyhodnoceni %>%
mutate(
dopis =
paste0("Milá účastnice, milý účastníku turnaje PGG,\n\n\n\n",
"nejprve Vám ještě jednou srdečně děkujeme za Vaší účast v turnaji -- bez Vás by nebylo možné zkoumat ",
"lidskou kooperaci, která byla předmětem naší studie. ",
"Dále Vám v e-mailu sdělujeme Váš výsledek v turnaji a jaká odměna Vám náleží. \n\n",
"Toto je náš druhý pokus Vám poslat výsledky hromadně, první se příliš nevydařil. ",
"Pokud jste první e-mail s výsledky dostali, je tento bepředmětný -- nejsou zde nové informace, ",
"jen se ještě jednou snažíme obeslat účastníky najednou.\n\n",
"Jelikož vaše skupina získala dohromady ", soucetSkupiny, " HK a Vy osobně ",
celkem, " HK, jste v celkovém pořadí ", umisteni, odmenit, "\n\n",
"Pro zajímavost, maximálního možného výsledku 1600 HK za celou skupinu dosáhlo 6 skupin a ",
"jejich členky a členové si tak rovným dílem rozdělili odměny za 1. až 24. místo ",
"(všichni shodně měli osobní výsledek 400 HK, jinak konec konců nebylo možné maxima dosáhnout). ",
"Nejvyšší osobní výsledek v celém turnaji je 417,5 HK, ale ten znamenal 'jen' 29. místo.",
"\n\n\n\nS úctou,\nFrantišek Kalvas a Pavlína Máchová")
) %>% ungroup %>% select(email, dopis) %>% filter(!is.na(email))
dopisy
View(dopisy)
## Skript na zpracování a odeslání e-mailu s oznámením odměn účastníkům turnaje PGG
## Encoding: windows-1250
## Vytvořil: 2021-04-21 FrK
## Upravil: 2021-05-12 FrK
# ## Hlavička a načtení dat -----------------------------------------------
## Smazání paměti
rm(list = ls())
## Package
library(dplyr)
library(writexl)
## Načtení dat
load("vsechnaCistaData.RData")
# ## Odměny ---------------------------------------------------------------
## Nejdřív je potřeba znovu vygenerovat vyhodnoceni:
dfv = vysledek %>% ungroup() %>% arrange(., desc(soucetSkupiny), desc(celkem)) %>%
select(email, session, soucetSkupiny, celkem) #%>%
# group_by(email) %>% mutate(x = 1) %>% mutate(x = sum(x)) %>%   # Kontrola, jestli tam není nějaký email dvakrát.
# arrange(., desc(x), email)  # OK, dopadlo to dobře, každý mail tu je jen jednou!
# vyhodnoceni
## Teď je potřeba vůbec nadefinovat vektor s odměnami a doplnit 0 na délku `vyhodnoceni`:
odmeny = c(seq(1000, 500, -100), 450, 400, 400, 350, rep(300,3), 250, rep(200, 5), 150,
150, rep(100, 6), rep(50, 16), 25, 25, rep(0, nrow(dfv) - 45))
# length((odmeny))
# sum(odmeny)
# SUPER! Sedí to!
## Tak... Teď připojím `odmeny` jako další proměnnou do `vyhodnoceni` a
# rovnou každému vypočtu jeho odměnu:
# 1) seskupím je podle `soucetSkupiny` a podle `celkem`, tím mi přirozeně vzniknou skupinky,
#    které si budou dělit odměny průměrem (při rovnosti bodů skupiny vytváří `super-skupiny`
#    a uvnitř nich si dělí odměnu rovným dílem hráči se stejným počtem bodů)
# 2) uvnitř skupin daných rovnými body (jak skupin tak hráčů) spočítám průměrné odměny
# 3) když budou body unikátní, zkrátka se replikuje hodnota, když ne, rozdělí se
# 4) využívám toho, že žebříček hráčů a jejich výsledků už je seřazený sestupně, od nejlepší skupiny
#    po nejhorší, a totéž s hráči, když k tomu pak přidám sestupně seřazené odměny, snadno to spočtu
vyhodnoceni = cbind(dfv, 'odmena' = odmeny, misto = 1:nrow(dfv)) %>% group_by(soucetSkupiny, celkem) %>%
mutate(odmena = mean(odmena),
odmena = if_else(odmena == 368.75, 370, odmena),  # Bude to stát sice 30 Kč navíc, ale zaokrouhlíme to na celé desetikoruny nahoru, přeci nebudu 24 vítězům posílat 368.75 Kč 24x...
# 5) a rovnou si tu připravím proměnné nutné pro sestavení emailu hráčům
od = min(misto),
do = max(misto),
umisteni = if_else(od == do,
paste0("na ", od, ". místě"),
paste0("na ", od, ". až ", do, ". místě")),
odmenit= if_else(odmena == 0,
". Toto umístění je, Bohu žel, bez finanční odměny.",
paste0(", za což Vám náleží odměna ", odmena, " Kč. Pošlete nám prosím číslo účtu, abychom Vám mohli odměnu zaslat.")),
email = if_else(email == "annaraichlova@s", "annaraichlova@seznam.cz", email)
)
vyhodnoceni
dopisy = vyhodnoceni %>%
mutate(
dopis =
paste0("Milá účastnice, milý účastníku turnaje PGG,\n\n\n\n",
"nejprve Vám ještě jednou srdečně děkujeme za Vaší účast v turnaji -- bez Vás by nebylo možné zkoumat ",
"lidskou kooperaci, která byla předmětem naší studie. ",
"Dále Vám v e-mailu sdělujeme Váš výsledek v turnaji a jaká odměna Vám náleží. \n\n",
"Toto je náš druhý pokus Vám poslat výsledky hromadně, první se příliš nevydařil. ",
"Pokud jste první e-mail s výsledky dostali, je tento bepředmětný -- nejsou zde nové informace, ",
"jen se ještě jednou snažíme obeslat účastníky najednou.\n\n",
"Nyní k výsledkům. Jelikož vaše skupina získala dohromady ", soucetSkupiny, " HK a Vy osobně ",
celkem, " HK, jste v celkovém pořadí ", umisteni, odmenit, "\n\n",
"Pro zajímavost, maximálního možného výsledku 1600 HK za celou skupinu dosáhlo 6 skupin a ",
"jejich členky a členové si tak rovným dílem rozdělili odměny za 1. až 24. místo ",
"(všichni shodně měli osobní výsledek 400 HK, jinak konec konců nebylo možné maxima dosáhnout). ",
"Nejvyšší osobní výsledek v celém turnaji je 417,5 HK, ale ten znamenal 'jen' 29. místo.",
"\n\n\n\nS úctou,\nFrantišek Kalvas a Pavlína Máchová")
) %>% ungroup %>% select(email, dopis) %>% filter(!is.na(email))
dopisy
library(readr)
poslat = read_xlsx("prehled.xlsx")
library(readxl)
poslat = read_xlsx("prehled.xlsx")
View(poslat)
poslat = read_csv2("prehled.csv")
poslat = read_csv2("prehled.csv") %>% select(dopisDorucen)
poslat = read_csv2("prehled.csv") %>% select(email, dopisDorucen)
poslat = read_csv2("prehled.csv") %>% select(email, dopisDorucen)
dopisy2 = left_join(dopisy, poslat)
View(dopisy2)
dopisy2 = left_join(dopisy, poslat) %>% filter(!dopisDorucen)
## Pro otestování adres ještě uložím adresy do Excelu a tam odtud to ručně nakopíruju do řádku mailu:
write_xlsx(dopisy2, "kontrolaV02.xlsx")
## Skript na zpracování a odeslání e-mailu s oznámením odměn účastníkům turnaje PGG
## Encoding: windows-1250
## Vytvořil: 2021-04-21 FrK
## Upravil: 2021-05-12 FrK
# ## Hlavička a načtení dat -----------------------------------------------
## Smazání paměti
rm(list = ls())
## Package
library(dplyr)
library(readr)
library(readxl)
library(writexl)
## Načtení dat
load("vsechnaCistaData.RData")
# ## Odměny ---------------------------------------------------------------
## Nejdřív je potřeba znovu vygenerovat vyhodnoceni:
dfv = vysledek %>% ungroup() %>% arrange(., desc(soucetSkupiny), desc(celkem)) %>%
select(email, session, soucetSkupiny, celkem) #%>%
# group_by(email) %>% mutate(x = 1) %>% mutate(x = sum(x)) %>%   # Kontrola, jestli tam není nějaký email dvakrát.
# arrange(., desc(x), email)  # OK, dopadlo to dobře, každý mail tu je jen jednou!
# vyhodnoceni
## Teď je potřeba vůbec nadefinovat vektor s odměnami a doplnit 0 na délku `vyhodnoceni`:
odmeny = c(seq(1000, 500, -100), 450, 400, 400, 350, rep(300,3), 250, rep(200, 5), 150,
150, rep(100, 6), rep(50, 16), 25, 25, rep(0, nrow(dfv) - 45))
# length((odmeny))
# sum(odmeny)
# SUPER! Sedí to!
## Tak... Teď připojím `odmeny` jako další proměnnou do `vyhodnoceni` a
# rovnou každému vypočtu jeho odměnu:
# 1) seskupím je podle `soucetSkupiny` a podle `celkem`, tím mi přirozeně vzniknou skupinky,
#    které si budou dělit odměny průměrem (při rovnosti bodů skupiny vytváří `super-skupiny`
#    a uvnitř nich si dělí odměnu rovným dílem hráči se stejným počtem bodů)
# 2) uvnitř skupin daných rovnými body (jak skupin tak hráčů) spočítám průměrné odměny
# 3) když budou body unikátní, zkrátka se replikuje hodnota, když ne, rozdělí se
# 4) využívám toho, že žebříček hráčů a jejich výsledků už je seřazený sestupně, od nejlepší skupiny
#    po nejhorší, a totéž s hráči, když k tomu pak přidám sestupně seřazené odměny, snadno to spočtu
vyhodnoceni = cbind(dfv, 'odmena' = odmeny, misto = 1:nrow(dfv)) %>% group_by(soucetSkupiny, celkem) %>%
mutate(odmena = mean(odmena),
odmena = if_else(odmena == 368.75, 370, odmena),  # Bude to stát sice 30 Kč navíc, ale zaokrouhlíme to na celé desetikoruny nahoru, přeci nebudu 24 vítězům posílat 368.75 Kč 24x...
# 5) a rovnou si tu připravím proměnné nutné pro sestavení emailu hráčům
od = min(misto),
do = max(misto),
umisteni = if_else(od == do,
paste0("na ", od, ". místě"),
paste0("na ", od, ". až ", do, ". místě")),
odmenit= if_else(odmena == 0,
". Toto umístění je, Bohu žel, bez finanční odměny.",
paste0(", za což Vám náleží odměna ", odmena, " Kč. Pošlete nám prosím číslo účtu, abychom Vám mohli odměnu zaslat.")),
email = if_else(email == "annaraichlova@s", "annaraichlova@seznam.cz", email)
)
vyhodnoceni
dopisy = vyhodnoceni %>%
mutate(
dopis =
paste0("Milá účastnice, milý účastníku turnaje PGG,\n\n\n\n",
"nejprve Vám ještě jednou srdečně děkujeme za Vaší účast v turnaji -- bez Vás by nebylo možné zkoumat ",
"lidskou kooperaci, která byla předmětem naší studie. ",
"Dále Vám v e-mailu sdělujeme Váš výsledek v turnaji a jaká odměna Vám náleží. \n\n",
"Toto je náš druhý pokus Vám poslat výsledky hromadně, první se příliš nevydařil. ",
"Pokud jste první e-mail s výsledky dostali, je tento bepředmětný -- nejsou zde nové informace, ",
"jen se ještě jednou snažíme obeslat účastníky najednou.\n\n",
"Nyní k výsledkům. Jelikož vaše skupina získala dohromady ", soucetSkupiny, " HK a Vy osobně ",
celkem, " HK, jste v celkovém pořadí ", umisteni, odmenit, "\n\n",
"Pro zajímavost, maximálního možného výsledku 1600 HK za celou skupinu dosáhlo 6 skupin a ",
"jejich členky a členové si tak rovným dílem rozdělili odměny za 1. až 24. místo ",
"(všichni shodně měli osobní výsledek 400 HK, jinak konec konců nebylo možné maxima dosáhnout). ",
"Nejvyšší osobní výsledek v celém turnaji je 417,5 HK, ale ten znamenal 'jen' 29. místo.",
"\n\n\n\nS úctou,\nFrantišek Kalvas a Pavlína Máchová")
) %>% ungroup %>% select(email, dopis) %>% filter(!is.na(email))
dopisy
poslat = read_csv2("prehled.csv") %>% select(email, dopisDorucen)
dopisy2 = left_join(dopisy, poslat) %>% filter(!dopisDorucen)
# ## Odeslání personalizovaných výsledků: ---------------------------------
library(emayili)
library(dplyr)
library(magrittr)
for (d in 1:nrow(dopisy2)) {
email <- envelope() %>%
from("kalvas@kss.zcu.cz") %>%
to(dopisy2$email[d]) %>%
subject(qp_encode("Vyhodnocení turnaje PGG (21.4.2021--2.5.2021): Druhý pokus o hromadné odeslání")) %>%
text(qp_encode(dopisy2$dopis[d]))
# print(email, details = T)
smtp <- server(host = "smtp.zcu.cz",
port = 465,
username = "kalvas",
password = "Dingo933")
smtp(email, verbose = TRUE)
}
vyhodnoceni
write_xlsx(vyhodnoceni %>% select(email, odmena), "odmeny.xlsx")
write_xlsx(vyhodnoceni %>% ungroup() %>% select(email, odmena), "odmeny.xlsx")
